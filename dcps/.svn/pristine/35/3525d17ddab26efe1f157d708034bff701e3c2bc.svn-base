<html><head>
<style type="text/css">
	td .headers{color: #CC6342;
	}

   td .headerCont {
   		
   		background-color:#FBF4EB;
   		font-family:calibri;
   		color: #CC6342;
   		text-decoration : underline; 
   }
 </style>


<script type="text/javascript">
function digitFormat(formfield)
{	var val;
	if(window.event.keyCode>47 && window.event.keyCode<58)
	{
		val=formfield.value;
		if(val[1]!=null)
		{
			if(val[1].length>1)
			{
				window.event.keyCode=0;
			}
		}
	}
	else
	{
		window.event.keyCode=0;
	}
}

function dateFormat(field)
{
	var value=new String(field.value);
	if(value.length==2)
	{
		field.value=value+'/'
	}
	if(value.length==5)
	{
		field.value=value+'/'
	}
}
var dtCh= "/";
var minYear=1900;
var maxYear=2100;

function validateDate(dtCtrl){
		var dtStr = dtCtrl.value;
	if(dtStr != '')
	{
		var daysInMonth = DaysArray(12)
		var pos1=dtStr.indexOf(dtCh)
		var pos2=dtStr.indexOf(dtCh,pos1+1)
		var strDay=dtStr.substring(0,pos1)
		var strMonth=dtStr.substring(pos1+1,pos2)
		var strYear=dtStr.substring(pos2+1)
		strYr=strYear
		if (strDay.charAt(0)=="0" && strDay.length>1) strDay=strDay.substring(1)
		if (strMonth.charAt(0)=="0" && strMonth.length>1) strMonth=strMonth.substring(1)
		for (var i = 1; i <= 3; i++) {
			if (strYr.charAt(0)=="0" && strYr.length>1) strYr=strYr.substring(1)
		}
		month=parseInt(strMonth)
		day=parseInt(strDay)
		year=parseInt(strYr)
		if (pos1==-1 || pos2==-1){
				dtCtrl.focus();
			alert('Please Enter Date in dd/mm/yyyy format ')
			dtCtrl.value='';
			return false
		}
		if (strMonth.length<1 || month<1 || month>12){
				dtCtrl.focus();
			alert('Please Enter valid Month ')
			dtCtrl.value='';
			return false
		}
		if (strDay.length<1 || day<1 || day>31 || (month==2 && day>daysInFebruary(year)) || day > daysInMonth[month]){
				dtCtrl.focus();
			alert('Please Enter valid Date ')
			dtCtrl.value='';
			return false
		}
		if (strYear.length != 4 || year==0 || year<minYear || year>maxYear){
				dtCtrl.focus();
			alert('Please Enter valid year ')
			dtCtrl.value='';
			return false
		}
		if (dtStr.indexOf(dtCh,pos2+1)!=-1 || isInteger(stripCharsInBag(dtStr, dtCh))==false){
				dtCtrl.focus();
			alert('Please Enter Date in dd/mm/yyyy format ');
			dtCtrl.value='';
			return false;
		}
		return true;
	}
	return false; 
}
function DaysArray(n) {
	for (var i = 1; i <= n; i++) {
		this[i] = 31
		if (i==4 || i==6 || i==9 || i==11) {this[i] = 30}
		if (i==2) {this[i] = 29}
   } 
   return this
}
function daysInFebruary (year){
	// February has 29 days in any year evenly divisible by four,
    // EXCEPT for centurial years which are not also divisible by 400.
    return (((year % 4 == 0) && ( (!(year % 100 == 0)) || (year % 400 == 0))) ? 29 : 28 );
}
function isInteger(s,msg)
{
	var i;	
    for (i = 0; i < s.length; i++)
    {   
        // Check that current character is number.
        var c = s.charAt(i);
        if (((c < "0") || (c > "9"))) 
        {
        	//alert(msg +CMN_TxtIsNumber);
        	ctrl.focus();
	        return false;
	     }
    }
    // All characters are numbers.
    return true;
}
function stripCharsInBag(s, bag){
	var i;
    var returnString = "";
    // Search through string's characters one by one.
    // If character is not in bag, append to returnString.
    for (i = 0; i < s.length; i++){   
        var c = s.charAt(i);
        if (bag.indexOf(c) == -1) returnString += c;
    }
    return returnString;
}

function GetData()
{
	var location = self.location.href;
	var lastIndex = location.lastIndexOf("/");
	
	var parentLoc = location.substring(0,lastIndex+1);
	
	
var Excel, Book;	// Declare the variables
	Excel = new ActiveXObject("Excel.Application");	// Create the Excel application object.
	Excel.Visible = false;	// Make Excel invisible.
	ExcelPath = parentLoc+"ContributionData.xls";
	Excel.Workbooks.Open(ExcelPath);
	ActiveSheet = Excel.ActiveSheet;

	
		
	
	
	document.getElementById("TreasuryName").innerHTML = ActiveSheet.Cells(1,2).Value;
	document.getElementById("DDOName").innerHTML = ActiveSheet.Cells(2,2).Value;
	document.getElementById("BillGroupName").innerHTML = ActiveSheet.Cells(3,2).Value;
	document.getElementById("SchemeName").innerHTML = ActiveSheet.Cells(4,2).Value;
	document.getElementById("Month").innerHTML = ActiveSheet.Cells(5,2).Value;
	document.getElementById("Year").innerHTML = ActiveSheet.Cells(7,2).Value;

	
	

	
		 TotalEmp = ActiveSheet.Cells(10,2);
	

	
	
	var table=document.getElementById("ContributionTable");

	for( i = 0;i<TotalEmp;i++)
	{
	RowNumber = 13+i;
	
	var newRow = table.insertRow(-1);

	var Cell1 = newRow.insertCell(-1);
		var Cell2 = newRow.insertCell(-1);
		var Cell3 = newRow.insertCell(-1);
		var Cell4 = newRow.insertCell(-1);
		var Cell5 = newRow.insertCell(-1); 
		var Cell6 = newRow.insertCell(-1); 
		var Cell7 = newRow.insertCell(-1); 
		var Cell8 = newRow.insertCell(-1); 
		var Cell9 = newRow.insertCell(-1); 
		var Cell10 = newRow.insertCell(-1);
		var Cell11 = newRow.insertCell(-1);
		var Cell12 = newRow.insertCell(-1);   

		
   	Cell1.align="center";
   	Cell2.align="center";
   	Cell3.align="center";
   	Cell4.align="center";
	Cell5.align="center";
   	Cell6.align="center";
	Cell7.align="center";
   	Cell8.align="center";
	Cell9.align="center";
	Cell10.align="center";
	Cell11.align="center";
	Cell12.align="center";

	basic = ActiveSheet.Cells(RowNumber,4).Value;
	dp = 0;

	da = basic * 27 / 100;
	contribution = (basic + da)*0.1;

	Curr_Row = i + 1;

	SelReg = "";
	SelDel = "";
	SelDA = "";
	SelPay = "";
	Selected = "Selected = true";
	
	PayType = ActiveSheet.Cells(RowNumber,5).Value;
	

	if(PayType == "Regular")
	{
		SelReg = Selected;
	}

	if(PayType == "Delayed")
	{
		SelDel = Selected;
	}

	if(PayType == "DA Arrear")
	{
		SelDA = Selected;
	}

	if(PayType == "Pay Arrear")
	{
		SelPay = Selected;
	}

	var start_date =ActiveSheet.Cells(RowNumber,10).Value;
	var start_month = ActiveSheet.Cells(RowNumber,11).Value;
	var start_year = ActiveSheet.Cells(RowNumber,12).Value;

	var end_date =ActiveSheet.Cells(RowNumber,13).Value;
	var end_month = ActiveSheet.Cells(RowNumber,14).Value;
	var end_year = ActiveSheet.Cells(RowNumber,15).Value;
	
	var ContStartdate= start_date + '/'+ start_month + '/'+ start_year;
	var ContEnddate= end_date + '/'+ end_month + '/'+ end_year;
	
	
	Cell1.innerHTML = '<label id="name'+Curr_Row+'">'+ ActiveSheet.Cells(RowNumber,1).Value+'</label>' ;
	Cell2.innerHTML = '<label id="dcps'+Curr_Row+'">'+ ActiveSheet.Cells(RowNumber,2).Value+'</label>' ;
	Cell3.innerHTML = '<input type="text" size="10"  id="start'+Curr_Row+'" name="start'+Curr_Row+'" value="'+ContStartdate+'" onkeypress="digitFormat(this);dateFormat(this);" '+ ' onBlur="validateDate(this);compareDates('+Curr_Row+');"  />' ;
	Cell4.innerHTML = '<input type="text" size="10"  id="end'+Curr_Row+'" name="end'+Curr_Row+'" value="'+ContEnddate+'" onkeypress="digitFormat(this);dateFormat(this);" '+ ' onBlur="validateDate(this);compareDates('+Curr_Row+');"  />' ;
	Cell5.innerHTML = '<label id="paycomm'+Curr_Row+'">'+ ActiveSheet.Cells(RowNumber,3).Value+'</label>' ;
	Cell6.innerHTML = ' <select name="cmbTypeOfPayment" id="cmbTypeOfPayment'+Curr_Row+'"  style="width: 107">'
	+ ' <option value="Regular"'+SelReg+' >Regular</option> <option value="Delayed" '+SelDel+'>Delayed</option> <option value="DA Arrear"'+SelDA+'>DA Arrear</option> <option value="Pay Arrear"'+SelPay+'>Pay Arrear</option></select>'; 
	Cell7.innerHTML = '<input type="text" size="10"  id="basic'+Curr_Row+'" name="basic" value="'+basic+'" onChange="ChangeContri('+Curr_Row+');"  />' ;
	Cell8.innerHTML = '<label id="dp'+Curr_Row+'">'+dp+'</label>' ;
	Cell9.innerHTML = '<label id="da'+Curr_Row+'">'+da+'</label>' ;
	Cell10.innerHTML = '<label id="contribution'+Curr_Row+'">'+contribution+'</label>' ;
    Cell11.innerHTML = '<label onClick="AddRow('+Curr_Row+');"><a href = "#">Add</a></label>';
    Cell12.innerHTML = '<label id="empId'+Curr_Row+'" style="display:none">'+ActiveSheet.Cells(RowNumber,9).Value+'</label>' ;

    //Cell12.style.display = "none";
   	

	
		
	
	}
	Excel.Quit();
}


function AddRow(Curr_Row)
{
	var oRows = document.getElementById('ContributionTable').getElementsByTagName('tr');
	TotalEmp = oRows.length-1;
	
	var table=document.getElementById("ContributionTable");
	
	
	RowNumber = 13+i;
	
	var newRow = table.insertRow(-1);

	var Cell1 = newRow.insertCell(-1);
		var Cell2 = newRow.insertCell(-1);
		var Cell3 = newRow.insertCell(-1);
		var Cell4 = newRow.insertCell(-1);
		var Cell5 = newRow.insertCell(-1); 
		var Cell6 = newRow.insertCell(-1); 
		var Cell7 = newRow.insertCell(-1); 
		var Cell8 = newRow.insertCell(-1); 
		var Cell9 = newRow.insertCell(-1); 
		var Cell10 = newRow.insertCell(-1);
		var Cell11 = newRow.insertCell(-1);
		var Cell12 = newRow.insertCell(-1);   

		
   	Cell1.align="center";
   	Cell2.align="center";
   	Cell3.align="center";
   	Cell4.align="center";
	Cell5.align="center";
   	Cell6.align="center";
	Cell7.align="center";
   	Cell8.align="center";
	Cell9.align="center";
	Cell10.align="center";
	Cell11.align="center";
	Cell12.align="center";

	
	basic = document.getElementById("basic"+Curr_Row).value;
	dp = 0;
	
	da = Math.round(basic * 0.27);
	tempBasic = Number(basic) + da;
	contribution = (tempBasic)*0.1;

	Curr_Row_New = TotalEmp + 1;
	
	
	Cell1.innerHTML = '<label id="name'+Curr_Row_New+'">'+ document.getElementById("name"+Curr_Row).innerHTML+'</label>' ;
	Cell2.innerHTML = '<label id="dcps'+Curr_Row_New+'">'+ document.getElementById("dcps"+Curr_Row).innerHTML+'</label>' ;
	Cell3.innerHTML = '<input type="text" size="10"  id="start'+Curr_Row_New+'" name="start'+Curr_Row_New+'" value="'+document.getElementById("start"+Curr_Row).value+'" onkeypress="digitFormat(this);dateFormat(this);" '+ ' onBlur="validateDate(this);compareDates('+Curr_Row_New+');" />' ;
	Cell4.innerHTML = '<input type="text" size="10"  id="end'+Curr_Row_New+'" name="end'+Curr_Row_New+'" value="'+document.getElementById("end"+Curr_Row).value+'" onkeypress="digitFormat(this);dateFormat(this);" '+ ' onBlur="validateDate(this);compareDates('+Curr_Row_New+');" />' ;
	Cell5.innerHTML = '<label id="paycomm'+Curr_Row_New+'">'+ document.getElementById("paycomm"+Curr_Row).innerHTML+'</label>' ;
	Cell6.innerHTML = ' <select name="cmbTypeOfPayment" id="cmbTypeOfPayment'+Curr_Row_New+'"  style="width: 107">'
	+ ' <option value="Regular"'+SelReg+' >Regular</option> <option value="Delayed" '+SelDel+'>Delayed</option> <option value="DA Arrear">DA Arrear</option> <option value="Pay Arrear">Pay Arrear</option></select>'; 

	Cell7.innerHTML = '<input type="text" size="10"  id="basic'+Curr_Row_New+'" name="basic" value="'+basic+'" onChange="ChangeContri('+Curr_Row_New+');"  />' ;
	Cell8.innerHTML = '<label id="dp'+Curr_Row_New+'">'+dp+'</label>' ;
	Cell9.innerHTML = '<label id="da'+Curr_Row_New+'">'+da+'</label>' ;
	Cell10.innerHTML = '<label id="contribution'+Curr_Row_New+'">'+contribution+'</label>' ;
    Cell11.innerHTML = '<label onClick="AddRow('+Curr_Row_New+');"><a href = "#">Add</a></label>';
    Cell12.innerHTML = '<label id="empId'+Curr_Row_New+'" style="display:none">'+document.getElementById("empId"+Curr_Row).innerHTML+'</label>' ;

	
		
	
		
}

function ChangeContri(Curr_Row)
{
	basic = document.getElementById("basic"+Curr_Row).value;
	
	da=Math.round(basic*0.27);
	
	tempBasic = Number(basic) + da;
	contribution = (tempBasic) * 0.1;

	
	document.getElementById("da"+Curr_Row).innerHTML=da;
	document.getElementById("contribution"+Curr_Row).innerHTML = contribution;
}


function SubmitData()
{
	
	var Excel, Book;	// Declare the variables
	Excel = new ActiveXObject("Excel.Application");	// Create the Excel application object.
	Excel.Visible = true;	// Make Excel invisible.
	var location = self.location.href;
	var lastIndex = location.lastIndexOf("/");
	
	var parentLoc = location.substring(0,lastIndex+1);
	
	path = parentLoc+"ContributionData.xls";
	Book = Excel.Workbooks.Open(path);	// Create a new work book.
	
     
	
	ActiveSheet = Excel.ActiveSheet;
	var ExcelRows = ActiveSheet.Cells(10,2).Value;
	var oRows = document.getElementById('ContributionTable').getElementsByTagName('tr');
	TotalRows = oRows.length-1;
	
	var initRows = 13;

	var TableRow = 1;
	for(i=0;i<TotalRows;i++)
	{
		var Curr_row = initRows + i;
		if((i+1)>ExcelRows)
		{
			
			 ActiveSheet.Cells(10,2).Value = TotalRows;
			 
			 ActiveSheet.Cells(Curr_row,1).Value = document.getElementById("name"+TableRow).innerHTML;
				ActiveSheet.Cells(Curr_row,2).Value = document.getElementById("dcps"+TableRow).innerHTML;
				ActiveSheet.Cells(Curr_row,3).Value = document.getElementById("payComm"+TableRow).innerHTML;
		}
		ActiveSheet.Cells(Curr_row,4).Value = document.getElementById("basic"+TableRow).value;
		ActiveSheet.Cells(Curr_row,5).Value = document.getElementById("cmbTypeOfPayment"+TableRow).value;
		ActiveSheet.Cells(Curr_row,6).Value = document.getElementById("da"+TableRow).innerHTML;
		ActiveSheet.Cells(Curr_row,7).Value = document.getElementById("dp"+TableRow).innerHTML;
		ActiveSheet.Cells(Curr_row,8).Value = document.getElementById("contribution"+TableRow).innerHTML;
		ActiveSheet.Cells(Curr_row,9).Value = document.getElementById("empId"+TableRow).innerHTML;
		

			
		var start_temp =document.getElementById("start"+TableRow).value;
		var start_date = start_temp.split('/');
		
		
		var end_temp =document.getElementById("end"+TableRow).value;
		var end_date = end_temp.split('/');

		
		
		ActiveSheet.Cells(Curr_row,10).Value = start_date[0];
		ActiveSheet.Cells(Curr_row,11).Value = start_date[1];
		ActiveSheet.Cells(Curr_row,12).Value = start_date[2];
		ActiveSheet.Cells(Curr_row,13).Value = end_date[0];
		ActiveSheet.Cells(Curr_row,14).Value = end_date[1];
		ActiveSheet.Cells(Curr_row,15).Value = end_date[2];
		
		TableRow++;
	}
	
	Book.SaveAs(path);		
	Excel.Quit();	// Close Excel with the Quit method on the Application 
}

function compareDates(rowNo)
{
	var today= new Date();
	var dcpsID = document.getElementById("dcpsId"+rowNo).innerHTML;
	var totalRows = document.getElementById("contributionTable").rows.length;

	var str3 = document.getElementById("txtStartDate"+rowNo).value;
    var str4 = document.getElementById("txtEndDate"+rowNo).value;
    if(str3 == '' || str4 == ''){
    	return;
    }
    var dt3  = parseInt(str3.substring(0,2),10); 
    var mon3 = parseInt(str3.substring(3,5),10); 
    var yr3  = parseInt(str3.substring(6,10),10); 
    var dt4  = parseInt(str4.substring(0,2),10); 
    var mon4 = parseInt(str4.substring(3,5),10); 
    var yr4  = parseInt(str4.substring(6,10),10); 
    
    var date3 = new Date(yr3, mon3-1, dt3);
    var date4 = new Date(yr4, mon4-1, dt4);
    
    var one_day = 1000*60*60*24;
    
    if(Math.ceil((date3.getTime() - today.getTime())/(one_day))>0){
    	alert('Future Date is not allowed');
    	document.getElementById("txtStartDate"+rowNo).value ="";
    	return;
    }
    if(Math.ceil((date4.getTime() - today.getTime())/(one_day))>0){
    	alert('Future Date is not allowed');
    	document.getElementById("txtEndDate"+rowNo).value ="";
    	return;
    }
    
	for(var i=1;i<totalRows;i++){
	    var str1 = document.getElementById("txtStartDate"+i).value; 
	    var str2 = document.getElementById("txtEndDate"+i).value; 

	    var dt1  = parseInt(str1.substring(0,2),10); 
	    var mon1 = parseInt(str1.substring(3,5),10); 
	    var yr1  = parseInt(str1.substring(6,10),10); 
	    var dt2  = parseInt(str2.substring(0,2),10); 
	    var mon2 = parseInt(str2.substring(3,5),10); 
	    var yr2  = parseInt(str2.substring(6,10),10); 

	    var date1 = new Date(yr1, mon1-1, dt1); 
	    var date2 = new Date(yr2, mon2-1, dt2);

	    var Diff1 = Math.floor((date3.getTime() - date1.getTime())/(one_day));
	    var Diff2 = Math.floor((date2.getTime() - date3.getTime())/(one_day));
	    var Diff3 = Math.floor((date4.getTime() - date1.getTime())/(one_day));
	    var Diff4 = Math.floor((date2.getTime() - date4.getTime())/(one_day));

		if(i!=rowNo && document.getElementById("dcpsId"+i).innerHTML == dcpsID && ((Diff1>=0 && Diff2>=0) || (Diff3>=0 && Diff4>=0))){
			alert('The contribution dates overlaps for the Same employee');
			document.getElementById("txtStartDate"+rowNo).value="";
			document.getElementById("txtEndDate"+rowNo).value="";
			return;
		}
	}
}

</script>


</head>
<body onLoad="GetData();" style="font-family:calibri">
<table border = "0" style="width:100%;border-color=#000;border-width:1;border-style:solid" cellpadding="0" cellspacing="0">
<tr>
	<td style="background-image: url(images/top.jpg);height=141; align="center">
		<img src="images/HomeBanner.jpg"/>
	</td>
	</tr>
	<tr>
	<td style="background-image: url(images/wintop.jpg);color:#fff;font-weight:bold" align="center">
	Offline Contribution for DCPS
	</td>
	
	
</tr>	

<tr>
<td style="border-color=#000;border-width:1;border-style:solid;height:400" valign="top">

<table border = "1" style="width:80%;" align = "center" cellpadding="0" cellspacing="0">
	<tr >
		<td class="headers">Treasury</td>
		<td ><span id ="TreasuryName"/></td>
		<td class="headers">DDO Name</td>
		<td><span id ="DDOName"/></td>
	</tr>
	
	<tr>
		<td class="headers">Bill Group</td>
		<td><span id ="BillGroupName"/></td>
		<td class="headers">Scheme</td>
		<td><span id ="SchemeName"/></td>
	</tr>
	
	<tr>
		<td class="headers">Month</td>
		<td><span id ="Month"/></td>
		<td class="headers">Year</td>
		<td><span id ="Year"/></td>
	</tr>
</table>
<br/>
<table  id = "ContributionTable" border = "1" width="80%" align = "center" cellpadding="0" cellspacing="0">
	<tr>
		<th class="headerCont">Name</th>
		<th class="headerCont">DCPS ID</th>
		<th class="headerCont">Start Date</th>
		<th class="headerCont">End Date</th>
		<th class="headerCont">Pay Commission</th>
		<th class="headerCont">Payment Type</th>
		<th class="headerCont">Basic</th>
		<th class="headerCont">DP</th>
		<th class="headerCont">DA</th>
		<th class="headerCont">Contribution</th>
		<th class="headerCont">Add Row</th>
	</tr>
</table>
</td></tr>
</table>
<br/>
<table border = "0" align = "center" width = "20%">
	<tr>
		<td align = "center"><input style="background-image: url(images/btn.jpg);color:#fff;font-weight:bold;font-family:calibri;border-color:#fff" type = "submit" id = "submit" value = "Save Data" onClick="SubmitData();"/></td>
	</tr>
</table>
</body>
</html>